$(function(){function a(a){var b=a.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+)/i);return b&&4===b.length?"#"+("0"+parseInt(b[1],10).toString(16)).slice(-2)+("0"+parseInt(b[2],10).toString(16)).slice(-2)+("0"+parseInt(b[3],10).toString(16)).slice(-2):a}var b=new fabric.Canvas("canvas"),c=$("#canvas"),d=$("#add-watermask-button"),e=$("#delete-watermask-button"),f=$("#add-text-button"),g=$('#color-opacity-controls input[type="range"]'),h=$('#color-opacity-controls input[type="color"]');b.setBackgroundImage(c.data("background"),b.renderAll.bind(b)),d.on("click",function(){mihaildev.elFinder.openManager({filter:"image",path:"image",callback:"addImage",url:"/admin/elfinder/manager?filter=image&path=image&callback=addImage",width:"auto",height:"auto",id:"addImage"})}),mihaildev.elFinder.register("addImage",function(a,c){var d=new Image;return d.src=a.url,d.onload=function(){var a=new fabric.Image(d,{left:10,top:10});b.add(a)},!0}),e.on("click",function(){var a=b.getActiveObject();b.remove(a)}),f.on("click",function(){var a=new fabric.IText("www.vitinhgiatot.com",{left:100,top:100,fontFamily:"Arial"});b.add(a)}),g.on("change",function(){var a=b.getActiveObject();a.setOpacity($(this).val()/100),b.renderAll()}),h.on("change",function(){var a=b.getActiveObject();a.setColor($(this).val()),b.renderAll()}),b.on("object:selected",function(){var c=b.getActiveObject();g.val(100*c.opacity),h.val(a(c.fill)),b.renderAll(),e.removeAttr("disabled").addClass("alert").removeClass("disabled")}),b.on("selection:cleared",function(){e.attr("disabled","disabled").removeClass("alert").addClass("disabled")}),$("#watermask-save").on("click",function(){console.log(JSON.stringify(b)),$.post("/admin/file/watermask-save?id=52",{fabric:JSON.stringify(b)},function(a){console.log(a)})})});